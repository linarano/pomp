<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
  
<mapper namespace="com.pompeu.user.party.dao.UserPartyDao">

  <resultMap type="party" id="partyMap">
    <id column="party_no" property="no"/>
    <result column="location_no" property="locationNo"/>
    <result column="name" property="title"/>
    <result column="content" property="content"/>
    <result column="register_date" property="registerDate"/>
    <result column="start_date" property="startDate"/>
    <result column="end_date" property="endDate"/>
    <result column="max_member" property="maxMember"/>
    <result column="in_out_ex" property="inOutEx"/>
    <result column="modify_date" property="modifyDate"/>
    <result column="inputTag" property="inputTag"/>

  </resultMap>

  <resultMap type="location" id="locationMap">
    <id column="location_no" property="locationNo"/>
    <result column="doo" property="doo"/>
    <result column="si" property="si"/>
    <result column="gun" property="gun"/>
    <result column="gu" property="gu"/>
    <result column="address" property="address"/>
    <result column="post_no" property="postNo"/>
  </resultMap> 

  <resultMap type="partyUser" id="partyUserMap">
    <id column="users_no" property="usersNo"/>
    <result column="party_no" property="partyNo"/>
    <result column="party_maker" property="partyMaker"/>
    <result column="join_date" property="joinDate"/>
  </resultMap>
  
  <resultMap type="users" id="usersMap">
    <id column="users_no" property="no"/>
    <result column="image" property="image"/>
    <result column="ex_type_no" property="exTypeNo"/>
  </resultMap>

  <resultMap type="partyImage" id="partyImageMap">
    <id column="party_image_no" property="partyImageNo"/>
    <result column="party_no" property="partyNo"/>
    <result column="image" property="image"/>
  </resultMap>
  
  <resultMap type="tagManagement" id="tagManagementMap">
    <id column="tag_no" property="tagNo"/>
    <result column="party_no" property="partyNo"/>
  </resultMap>
  
  <resultMap type="tagName" id="tagNameMap">
    <id column="tag_no" property="tagNo"/>
    <result column="tag" property="tag"/>
  </resultMap>  
  
  <resultMap type="partyWishlist" id="partyWishlistMap">
    <id column="party_no" property="partyNo"/>
    <result column="users_no" property="usersNo"/>
  </resultMap>
  
  <resultMap type="partyClaim" id="partyClaimMap">
    <id column="party_no" property="partyNo"/>
    <result column="users_no" property="userNo"/>
    <result column="claim_reason_no" property="claimReasonNo"/>
    <result column="claim_date" property="claimDate"/>
    <result column="status" property="status"/>
  </resultMap>  
  
  <resultMap type="claimReason" id="claimReasonMap">
    <id column="claim_reason_no" property="claimReasonNo"/>
    <result column="type" property="type"/>
  </resultMap>  
  
    <resultMap type="member" id="memberMap">
    <id column="member_no" property="no"/>
    <result column="member_type_no" property="memberTypeNo"/>
    <result column="sns_no" property="snsNo"/>
    <result column="join_date" property="joinDate"/>
    <result column="name" property="name"/>
    <result column="email" property="email"/>
    <result column="phone" property="phone"/>
    <result column="nickname" property="nickName"/>
    <result column="use_check;" property="useCheck"/>    
    <result column="login_date" property="loginDate"/>
    <result column="modify_date" property="modifyDate"/>
    <result column="admin_check" property="adminCheck"/>
    <result column="password" property="password"/>
    <result column="birth" property="birth"/>
    <result column="gender" property="gender"/>
      <collection property="memberType" resultMap="memberTypeMap"/>
  </resultMap>

    <!-- 소모임 목록 총 갯수 -->
	  <select id="countAll" resultType="int">
	  /*countAll*/
	    select count(*) from party
	  </select>
	  
    <!-- 소모임 목록 -->
	  <select id="findAll" resultType="HashMap">
	  /*findAll*/
       select 
              p.party_no                            as no,
              p.name                                as title,
              tn.tag                                as tag,
              p.max_member                          as max_member,
              lo.doo                                as doo,
              p.end_date                            as end_date,
              p.in_out_ex                           as in_out_ex
        from 
             party as p
       join location as lo
            on p.location_no = lo.location_no    
        join tag_management as tm
             on p.party_no = tm.party_no
        join tag_name as tn
             on tm.tag_no = tn.tag_no
        WHERE
          1=1
            <if test="inOutEx != null or inOutEx != ''">
                <if test="inOutEx == 'in'">
                and p.in_out_ex = '1'
                </if>
                <if test="inOutEx == 'out'">
                and p.in_out_ex = '2'
                </if>
            </if>
       <if test="sort == 'recency'">
         order by p.party_no desc
        </if>     
        <if test="sort == 'old'">
        order by p.party_no asc
        </if>     
        <if test="sort == 'end'">
        order by p.end_date 
        </if>     
           
	  </select>
  
    <!-- 소모임 등록 -->
	  <insert id="insert" parameterType="party">
	  /*insert*/
	    insert into party(name,max_member,content,start_date,end_date,in_out_ex) 
	    values(#{title},#{maxMember},#{content},#{startDate},#{endDate},#{inOutEx})
	  </insert>
	  
    <!-- 소모임 상세 -->
	  <select id="findByNo" resultType="PartyIntro" parameterType="int">
	  /*findByNo*/
        select 
                  lo.doo                  as doo,
                  p.name                  as title,
                  p.content               as content,
                  p.start_date            as startDate,
                  p.end_date              as endDate,
                  p.max_member            as maxMember,
                  tn.tag                  as tag,
                  m.name                  as name
            from 
                  party as p
            join location as lo
                 on p.location_no = lo.location_no 
            join tag_management as tm
                  on p.party_no = tm.party_no
            join tag_name as tn
                  on tm.tag_no = tn.tag_no
            join party_user as u
                  on p.party_no = u.party_no
                 and 
                  u.party_maker = '1'
            join member as m 
                 on m.member_no  = u.users_no 
	        where 
                p.party_no=#{no}
	  </select>

    <!-- 소모임 수정 -->
	  <update id="update" parameterType="party">
	  /*update*/
	    update 
	       party set 
		      location_no=#{locationNo},
		      name=#{name},
		      content=#{content},
		      start_date=#{startDate},
		      end_date=#{endDate},
		      max_member=#{maxMember},
		      in_out_ex=#{inOutEx}
	    where 
	      party_no=#{no}
	  </update>

    <!-- 소모임 삭제 -->
	  <delete id="delete" parameterType="int">
	   /*delete*/
	   delete 
	   from party 
	    where party_no=#{no}
	  </delete>
	
    <!-- 이미지 이름 가져오기 -->
      <select id="addImage" resultType="HashMap" parameterType="int">
      /*addImage*/
        select 
                pi.image                    as image
            from 
                  party as p
            join party_image as pi
                on pi.party_no = p.party_no
            where 
                p.party_no=#{no}
      </select>

    <!--운동 tag 가져오기-->
        <select id="findByExTag" resultType="HashMap" parameterType="int">
        /*findByExTag*/
		select  
		    tag_no    as tagNo,
		    tag       
		from
		    tag_name 
		order by
		     tag_no asc       
        </select>
          
</mapper>